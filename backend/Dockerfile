# --- ЭТАП 1: Установка зависимостей ---
# 1. Используем официальный образ Node.js версии 20 как базовый.
# 'alpine' - это легковесная версия Linux, что делает наш итоговый образ меньше.
FROM node:22-alpine AS builder

# 2. Устанавливаем рабочую директорию внутри контейнера.
# Все последующие команды будут выполняться из этой папки.
WORKDIR /app

# 3. Копируем package.json и package-lock.json в рабочую директорию.
# Мы копируем только эти файлы, чтобы Docker мог кэшировать установку зависимостей.
COPY package*.json ./

# 4. Устанавливаем зависимости проекта.
RUN npm install

# --- ЭТАП 2: Сборка финального образа ---
# 5. Используем тот же базовый образ для финального этапа.
FROM node:22-alpine

# 6. Снова устанавливаем рабочую директорию.
WORKDIR /app

# 7. Копируем установленные зависимости из этапа 'builder'.
COPY --from=builder /app/node_modules ./node_modules

# 8. Копируем весь остальной код нашего приложения (index.js, models, и т.д.).
COPY . .

# 9. Указываем порт, который наше приложение будет слушать внутри контейнера.
# Это информационная команда, она не открывает порт наружу.
EXPOSE 3000

# 10. Команда, которая будет выполняться при запуске контейнера.
# Запускаем наш сервер.
CMD ["node", "index.js"]